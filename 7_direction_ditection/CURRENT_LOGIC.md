# 現在の座標変換・比較ロジック

## 全体フロー

```
【GroundTruth側】
元データ（実世界座標、メートル単位）
    ↓
Step 1: 座標系変換（Y軸反転なし）← 修正済み
    x_lh = x_gt
    y_lh = y_gt  ← 反転しない
    z_lh = z_gt
    ↓
Step 2: 腰の中心を計算
    hip_center = (LEFT_HIP + RIGHT_HIP) / 2
    ↓
Step 3: 相対座標化（腰を原点とする）
    各関節座標 - hip_center
    ↓
【GT相対座標】(メートル単位)


【MediaPipe側】
元データ（正規化座標、0-1の範囲）
    ↓
Step 1: 腰の中心を計算
    hip_center = (LEFT_HIP + RIGHT_HIP) / 2
    ↓
Step 2: 相対座標化（腰を原点とする）
    各関節座標 - hip_center
    ↓
【MP相対座標】(正規化単位)


【比較】
GT相対座標 vs MP相対座標
    ↓
Step 1: 角度計算
    θ (XY平面) = atan2(y, x)
    ψ (XZ平面) = atan2(z, x)
    ↓
Step 2: 角度差
    Δθ = θ_MP - θ_GT
    Δψ = ψ_MP - ψ_GT
    ↓
Step 3: 正規化（-π～πの範囲）
```

---

## 具体例：frame 20のLEFT_SHOULDER

### 1. GroundTruth（元データ）
```
HIP:      [-0.190,  0.951, -2.252]  (メートル)
SHOULDER: [-0.237,  1.393, -2.225]  (メートル)
```

### 2. GroundTruth変換後

#### Step 1: 座標系変換（現在はY軸反転なし）
```
HIP:      [-0.190,  0.951, -2.252]  ← そのまま
SHOULDER: [-0.237,  1.393, -2.225]  ← そのまま
```

#### Step 2-3: 相対座標化
```
hip_center = [-0.190, 0.951, -2.252]

HIP:      [0.000, 0.000, 0.000]  ← 原点
SHOULDER: [-0.047, 0.442, 0.027]  ← 腰より左(-x)、上(+y)、前(+z)
```

### 3. MediaPipe（元データ）
```
HIP_LEFT:  [0.726, 0.642, -0.018]  (正規化)
HIP_RIGHT: [0.733, 0.633, +0.018]  (正規化)
SHOULDER:  [0.745, 0.830, +0.150]  (正規化)
```

### 4. MediaPipe変換後

#### Step 1: 相対座標化
```
hip_center = [0.730, 0.637, 0.000]

HIP_CENTER: [0.000, 0.000, 0.000]  ← 原点
SHOULDER:   [0.015, 0.193, 0.150]  ← 腰より右(+x)、下(+y)、奥(+z)
```

**注意**: MediaPipeのY軸は画像座標系（上から下が正）

### 5. 角度計算

#### GroundTruth SHOULDER
```
座標: [-0.047, 0.442, 0.027]

θ_GT = atan2(0.442, -0.047) = 96.08°
ψ_GT = atan2(0.027, -0.047) = 150.20°
```

#### MediaPipe SHOULDER
```
座標: [0.015, 0.193, 0.150]

θ_MP = atan2(0.193, 0.015) = 85.45°
ψ_MP = atan2(0.150, 0.015) = 84.10°
```

#### 角度差
```
Δθ = θ_MP - θ_GT = 85.45° - 96.08° = -10.63° ✓ 良好！
Δψ = ψ_MP - ψ_GT = 84.10° - 150.20° = -66.10° ← まだ大きい
```

---

## 現在の結果

### XY平面（Δθ）の角度差
- **平均**: 46.66°
- **主要関節**:
  - SHOULDER: ~10° ← 良好
  - KNEE: ~5° ← 非常に良好
  - ELBOW: ~60° ← 改善の余地あり
  - HIP: ~90° ← 原点のため角度が不安定

### XZ平面（Δψ）の角度差
- **平均**: 95.03°
- **問題**: Z軸（深度）方向の誤差が大きい
- **原因**: MediaPipeの単眼カメラからの深度推定の限界

---

## 重要な発見

### ✅ Y軸反転は不要だった
- coordinate_transform_plan.mdでは `y_lh = -y_gt` と記載
- しかし実際には**Y軸反転なし**が正しかった
- 理由: GroundTruthとMediaPipeが同じカメラ視点・同じ座標系を使用

### ✅ MediaPipeも相対座標化が必要
- MediaPipeの出力は**腰を原点としていない**
- 画像座標系（0-1の正規化座標）として出力される
- GroundTruthと同様に**腰を原点とした相対座標に変換**が必要

### ⚠️ スケールの違い
- GroundTruth: メートル単位（実世界）
- MediaPipe: 正規化単位（0-1の範囲）
- **角度比較はスケールに依存しない**ため問題なし
- 3D距離の直接比較は無意味

---

## 座標系の詳細検証

### 🔍 実データによる座標系の確認

相対座標化後の実データを検証した結果：

```
LEFT_SHOULDER（肩 = 腰より上）:
  GT: [-0.047,  +0.442,  0.027]  ← Y座標が正（上向き）✓
  MP: [ 0.015,  +0.193,  0.150]  ← Y座標が正（上向き）✓

LEFT_KNEE（膝 = 腰より下）:
  GT: [-0.076,  -0.458, -0.105]  ← Y座標が負（下向き）✓
  MP: [-0.016,  -0.190, -0.089]  ← Y座標が負（下向き）✓

RIGHT_SHOULDER（右肩）:
  GT: [ 0.072,  +0.437,  0.002]  ← X正（右）、Y正（上）✓
  MP: [ 0.015,  +0.181,  0.216]  ← X正（右）、Y正（上）✓
```

### ✅ 結論：GroundTruthもMediaPipeも実質的に同じ座標系

| 軸 | GroundTruth | MediaPipe | 一致？ |
|---|-------------|-----------|-------|
| **X軸** | 右が正 | 右が正 | ✅ 一致 |
| **Y軸** | 上が正 | 上が正 | ✅ 一致 |
| **Z軸** | 前が正 | 奥が正 | ⚠️ 違いあり |

### 📝 なぜY軸反転が不要だったのか？

#### 当初の誤った想定
```
GroundTruth: 右手座標系（Y-up）
MediaPipe:   左手座標系（Y-down、画像座標系）
→ だから y_lh = -y_gt が必要
```

#### 実際の状況
```
1. MediaPipeは生データでは画像座標系（Y-down）
   HIP:      Y = 0.637
   SHOULDER: Y = 0.830 (0.637より大 = 画像の下方向)
   KNEE:     Y = 0.438 (0.637より小 = 画像の上方向)

2. しかし相対座標化すると...
   SHOULDER: 0.830 - 0.637 = +0.193 (正 = 実際の上)
   KNEE:     0.438 - 0.637 = -0.199 (負 = 実際の下)

3. つまり、相対座標化により座標系が統一される！
```

#### 重要な洞察

**相対座標化（腰を原点とする）により、両者の座標系が自然に統一される**

- MediaPipeは画像座標系（Y-down）で出力
- しかし撮影対象（人物）は直立している
- カメラは正面から撮影
- → 相対座標化後は「腰からの方向ベクトル」となり、実世界の方向と一致
- → Y軸反転は不要どころか、**してはいけない**

### 🎯 座標系変換の真実

| 処理段階 | GroundTruth | MediaPipe |
|---------|-------------|-----------|
| **元データ** | 実世界座標（Y-up）| 画像座標（Y-down？）|
| **相対座標化後** | 腰中心（Y-up）| 腰中心（Y-up）← 統一！|
| **比較** | 同じ座標系で比較可能 ✓ | |

### 💡 補角問題の解決

当初、角度差が144°や167°など、ほぼ反対方向を示していた：

```
【Y軸反転あり（間違い）】
LEFT_SHOULDER: Δθ = 144.23° ← ほぼ反対方向！
LEFT_ELBOW:    Δθ = -167.69° ← ほぼ反対方向！

【Y軸反転なし（正解）】
LEFT_SHOULDER: Δθ = -10.63° ← 良好！
LEFT_ELBOW:    Δθ = -58.94° ← 改善！
```

**原因**: Y軸を反転したことで、上下が逆になり、角度が180°近く異なっていた。

---

## 今後の課題

1. **Z軸（深度）の精度向上**
   - 現在: Δψ平均95.03°
   - MediaPipeの深度推定の限界？
   - ステレオカメラやDepthカメラの検討

2. **HIPの角度不安定性**
   - HIPは原点(0,0,0)に近いため、角度が不安定
   - HIPの角度差は評価から除外すべき

3. **カメラキャリブレーション**
   - GroundTruthとMediaPipeのカメラパラメータの確認
   - レンズ歪み補正の有無

4. **時系列データの検証**
   - 現在: 1フレーム（frame 20）のみ
   - 複数フレームでの一貫性確認が必要

