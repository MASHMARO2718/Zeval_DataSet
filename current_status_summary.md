# エラー相関構造の計算方法の設計

## 目的

各関節の角度誤差がどのように相関しているかを定量化する。
例: 左肘の誤差が増えたら、左肩の誤差も増えるのか？

最終的に全ての関節ペアの相関係数を1つの行列にまとめる。

---

## 手元にあるデータ

```
フレーム数: F (例: 1000フレーム)
関節数: N (例: 33関節 or 主要な関節のみ)
平面: 2つ

各フレーム、各関節、各平面での角度誤差:
- Δθ[frame_id][joint_id] : XY平面での角度誤差
- Δψ[frame_id][joint_id] : XZ平面での角度誤差
```

---

## 相関係数の計算方法

### 基本的な考え方

**時系列での相関を見る**

各関節について、全フレームでの誤差を時系列データとして扱い、2つの関節の誤差時系列の相関係数を計算する。

### ステップ1: 時系列ベクトルの作成

各関節iについて、全フレームでの誤差を1次元配列にする:

```
関節iの誤差時系列（θの場合）:
error_θ_i = [Δθ[0][i], Δθ[1][i], Δθ[2][i], ..., Δθ[F-1][i]]

長さ: F（フレーム数）
```

例:
```
左肘のθ誤差: [0.05, 0.03, 0.08, 0.06, ...]  (F個の値)
左肩のθ誤差: [0.04, 0.02, 0.09, 0.07, ...]  (F個の値)
```

### ステップ2: ピアソン相関係数の計算

関節iと関節jの相関係数を計算:

```
r(i, j) = Pearson相関係数(error_i, error_j)

        Σ(error_i - mean_i)(error_j - mean_j)
r(i,j) = ────────────────────────────────────
         √[Σ(error_i - mean_i)²] × √[Σ(error_j - mean_j)²]

-1 ≤ r(i,j) ≤ 1
```

### ステップ3: 相関行列の構築

全ての関節ペア(i, j)について計算 → **N×N相関行列**

```
        joint_0  joint_1  joint_2  ...  joint_N
joint_0    1.0     0.85    -0.12   ...   0.34
joint_1   0.85     1.0      0.78   ...   0.21
joint_2  -0.12    0.78     1.0    ...   0.56
  ...     ...      ...      ...    ...   ...
joint_N   0.34    0.21     0.56   ...   1.0
```

**性質:**
- 対角成分は必ず1.0（自分自身との相関）
- 対称行列: r(i,j) = r(j,i)

---

## θとψの扱い方（3つのオプション）

### オプションA: 別々に計算（推奨：まずこれから）

XY平面とXZ平面を独立に扱う:

```
相関行列_θ: N×N  (XY平面での角度誤差の相関)
相関行列_ψ: N×N  (XZ平面での角度誤差の相関)
```

**メリット:**
- 平面ごとの特徴が明確に分かる
- 解釈しやすい
- 計算が軽い

**デメリット:**
- 2つの行列を見る必要がある

**使い方:**
- まずθ行列で「水平方向の誤差パターン」を把握
- 次にψ行列で「深度方向の誤差パターン」を把握

---

### オプションB: 結合して計算（詳細分析用）

各関節を2つの変数として扱う:

```
変数リスト:
joint_0_θ, joint_0_ψ, joint_1_θ, joint_1_ψ, ..., joint_N_θ, joint_N_ψ

相関行列: (2N) × (2N)
```

例（N=33の場合）: 66×66行列

**メリット:**
- 全ての関係性が1つの行列に統合される
- θとψ間の相関も分かる（例: left_elbow_θ と left_shoulder_ψ の相関）

**デメリット:**
- 行列が大きくなる
- 可視化が複雑

---

### オプションC: 3D誤差ノルムで計算（シンプル版）

角度ではなく、3D空間での誤差の大きさを使う:

```
各フレーム、各関節での3D誤差:
error[frame][joint] = sqrt(Δx² + Δy² + Δz²)

相関行列: N×N
```

**メリット:**
- 最もシンプル
- 「全体的な誤差の大きさ」の相関が分かる
- 解釈が直感的

**デメリット:**
- 方向の情報（θ, ψ）が失われる
- 角度の補正には直接使えない

---

## 推奨する分析の流れ

### Phase 1: 全体像の把握
**オプションC（3D誤差ノルム）**を使って、どの関節同士が連動して誤差を持つか把握

### Phase 2: 平面ごとの詳細分析
**オプションA（θとψを別々に）**で、各平面での誤差パターンを分析

### Phase 3: 必要に応じて詳細分析
特定の関節ペアが気になる場合、**オプションB**でθとψ間の相関も確認

---

## 計算の擬似コード

```python
import numpy as np

# データ準備
F = 1000  # フレーム数
N = 33    # 関節数

# オプションA: θの相関行列
errors_theta = np.zeros((F, N))
for frame in range(F):
    for joint in range(N):
        errors_theta[frame, joint] = delta_theta[frame][joint]

# 相関行列を計算（NumPyの組み込み関数）
correlation_matrix_theta = np.corrcoef(errors_theta.T)
# shape: (N, N)

# 同様にψの相関行列も計算
errors_psi = np.zeros((F, N))
for frame in range(F):
    for joint in range(N):
        errors_psi[frame, joint] = delta_psi[frame][joint]

correlation_matrix_psi = np.corrcoef(errors_psi.T)
```

---

## 可視化方法

### ヒートマップ
```python
import seaborn as sns
import matplotlib.pyplot as plt

sns.heatmap(correlation_matrix_theta, 
            vmin=-1, vmax=1, 
            cmap='coolwarm',
            xticklabels=joint_names,
            yticklabels=joint_names)
plt.title('Joint Error Correlation (θ)')
plt.show()
```

### 主要な関節のみ抽出
33×33は大きすぎる場合、主要関節（肩、肘、手首、腰、膝、足首）のみ抽出:

```python
important_joints = [11, 12, 13, 14, 15, 16, 23, 24, 25, 26, 27, 28]
# 12関節 → 12×12行列
```

---

## 期待される洞察

### 高い正の相関（r > 0.7）
- 同じ身体部位の関節（例: 左肩と左肘）
- 連動して誤差が発生している
- **→ 部位全体を補正する必要がある**

### 高い負の相関（r < -0.7）
- 一方が過大評価されると、他方が過小評価される
- **→ MediaPipeの特有のバイアス**

### 低い相関（-0.3 < r < 0.3）
- 独立に誤差が発生
- **→ 個別に補正可能**

---

## 次のステップ

1. ✅ 計算方法の設計（完了）
2. 実装（Python/NumPy）
3. データで実際に計算
4. 相関行列を可視化
5. パターンを分析
6. 補正フィルタの設計へ